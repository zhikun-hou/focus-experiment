# 开发文档
面向课题组内部同学，不要将此文档打包到最终交付客户的文件夹中

## 一、项目背景
### 1.1 实验脚本
> - 之前毕业的学长基于PsychoPy Builder在python下开发了实验脚本
> 但他只是用Builder构造了个简易原型，然后直接在.py文件上修改代码，导致维护困难
> - 因此我尽量将所有功能都在Builder中实现，然后按照编程范式对脚本进行少量修改，从而保证只接受过有限编程训练的心理学实验人员也可以对实验流程进行修改
> - PsychoPy的工程文件可在**src/tasks/project**文件夹下找到

### 1.2 界面程序
> - 前端原本是C#开发的，但那个学长把很多个项目的工程混在了一起，特别乱
> - 我基于NodeJS，使用Vite+Vue+ElementPlus重做了图形化界面
> - html/js通常用于网站开发，因此我还使用了Electron将程序打包为桌面程序

## 二、技术框架

### 2.1 分层说明
> - 【数据层】Sqlite
> 第一次启动时会在根目录下自动生成sqlite.db数据库文件
> 对应的代码文件夹为**src/sqlite**
> - 【服务层】Electron
> 可以将html网页打包为本地应用程序，其中渲染进程遵循**ES6**规范、主进程遵循**CommonJS**规范。文件操作、数据库处理等涉及到NodeJS的功能必须在主进程之间执行，两个进程之间通过**ipcMain.handle**和**ipcRenderer.invoke**进行通信
> Electron的入口是整个程序的入口，即**index.js**和**index.html**，启动程序时会从**src/controllers**文件夹中加载服务模块供渲染进程invoke调用
> - 【表现层】Vite + Vue3 + ElementPlus
> Vue是一个响应式的前端框架，运行在Electron的**渲染进程**中，其入口为**src/main.js**
> main.js加载组件库和Vue，然后启动App.vue组件，其子组件保存在文件夹**src/components**中
> Vite负责将js文件和.vue组件文件打包为一个整体的网页，打包后的文件夹为**dist**
> ElementPlus是一个前端组件库，文档可见**https://element-plus.org/zh-CN/component/button.html**
> - 【实验】通过**PsychoPy Builder 2022**生成，并**依照编程范式**对脚本文件进行了修改
> 实验保存在**src/tasks**文件夹中，对应的.psyexp工程文件则保存在**src/tasks/project**中，通过PsychoPy Builder打开工程文件、编译生成.py文件、按照编程范式进行修改、然后移动到tasks文件夹
> - 【量表】保存在**src/scales**文件夹中
> - 【配置文件】
> vite.config.js是vite打包的配置文件，非必要不修改
> package.json是项目本身和Electron共用的配置文件，可酌情修改
> experiment.config.js主要是数据库/量表/实验脚本的路径文件，非必要不修改
> experiment.config.json是界面的配置文件，参照格式进行修改即可
> - 【文档】使用.md格式，也就是MarkDown，程序员可在VsCode中下载**Markdown Preview Enhanced插件**，然后使用Ctrl+Shift+V快捷键进行预览。由于有些插件/在线浏览器不支持，需要说明**XX**表示重点提示

### 2.2 experiment.config.json
> - script对应实验/量表的文件名
> - args当中，name对应的是界面输入框显示的名称，key则是**映射到python文件中CONFIG对象的属性名**，default是默认值

## 三、操作规范

### 3.1 配置开发环境
> - 先下载nodejs和npm，然后cmd进入本文件夹下运行npm install，之后会自动安装依赖的包
> - 我所使用的node版本：v12.6.0
> - 如果无法正常安装依赖，大概率是**node或者包的版本问题**
> - 各个包的版本可见package.json

### 3.2 开发实验
> 1. 在PsychoPy Builder 2022中设计自己的实验，测试完毕后按**F5**生成.py文件
> 2. 将.py文件复制到src/tasks文件夹下，工程文件复制到src/tasks/project文件夹下
> 3. 打开.py文件，参照编程范式进行修改
> 4. 普通实验需要参考无后缀的.py代码，如果需要脑电，可参考后缀为_eeg.py的代码
> 5. 编辑experiment.config.json，按照格式为当前实验创建一个启动界面

### 3.3 编程范式
> 1. 在脚本第一行加入 from loader import *
> 目的1：屏蔽PsychoPy所依赖的pygame模块的自动输出，保证管道只用于传递实验数据
> 目的2：将传入的参数映射到CONFIG对象上
> 2. 搜索dialog，将相关代码全部注释掉
> 目的：PsychoPy通过自带的dialog输入框输入参数，取消之
> 注意：如果dialog在if语句中，则if语句的作用域内全部代码都要注释掉，之后同理
> 3. 搜索thisExp，将相关的行全部注释掉
> 目的：PsychoPy通过excel来记录数据，取消之
> 注意：请使用**Match Whole Word**，thisExperiment不算
> 4. 搜索log，将相关的行全部注释掉
> 目的：PsychoPy除了记录实验数据还会产生日志文件，取消之
> 注意：import中的log可以不用管
> 5. 对需要连接脑电或其它外部设备的实验，修改脚本以满足实验要求

> - 以上手动模式，因为太麻烦所以加了个自动编译脚本。运行**python compiler.py src/tasks/project/xxx.py**即可自动将其修改为满足范式的脚本
> 之后手动将.py文件移动到src/tasks文件夹下即可
> - 在脚本中如果需要使用参数，可以通过CONFIG['key']调用
> 其中key即是experiemnt.config.json中，arg的key字段中的值
> 除了args以外，还有一个默认的参数CONFIG['experimentId']
> - 向Electron请求记录数据，只需要直接调用record(block_id,trial_id,record_name,record_value)
> **为符合心理学实验者的习惯，block_id和trial_id都应该从1开始而不是从0开始**



### 3.4 程序测试
> - 在测试环境下，将experiment.config.js中的mode设置为**DEBUG**
> - 在正式发布时，将mode设置为**RELEASE**
> 1. 首先运行vite build或npm build，vite会将“网站”打包到dist文件夹
> 2. 然后运行npm start，electron会将“网站”打包为本地应用程序
> - 或者直接运行**npm test**，它是两者的组合

### 3.5 打包发布
> 1. 确保experiment.config.js中的mode设置为**RELEASE**
> 2. 确保已经运行过vite build或npm build或npm test，保证目前dist文件夹中的代码是最新版本
> 2. 在pakage.json的build中修改配置信息，无误后执行npm run dist打包发布
> 3. 在output文件夹中即可找到打包完成的项目，双击launch.exe即可运行
> - 注意：打包之前**清空output文件夹**，否则残留文件会导致报错
> - 注意：如果报错说下载某个文件失败的话，可以参考这个解决：https://segmentfault.com/a/1190000040356146

